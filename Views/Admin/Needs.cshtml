@model IEnumerable<UpliftBridge.Models.Need>

@{
    ViewData["Title"] = "Admin â€” Needs";
    var key = Context.Request.Query["key"].ToString();
    ViewBag.AdminKey = key;
}

<div class="kg-wrap kg-shell">
    <div class="kg-glass">
        <div class="d-flex align-items-start justify-content-between flex-wrap gap-3">
            <div>
                <div class="kg-kicker">ADMIN</div>
                <h1 class="kg-title">Needs</h1>
                <p class="kg-muted mb-0">All needs in the database (draft + published).</p>
            </div>

            <partial name="_AdminLinks" />
        </div>

        <hr style="border-color: rgba(255,255,255,.12);" />

        <div class="kg-card-light">
            <div class="table-responsive">
                <table class="table mb-0 kg-table">
                    <thead>
                        <tr>
                            <th style="width:70px;">ID</th>
                            <th>Title</th>
                            <th style="width:120px;">Category</th>
                            <th>Location</th>
                            <th style="width:120px;">Goal</th>
                            <th style="width:120px;">Raised</th>
                            <th style="width:120px;">Published</th>
                            <th style="width:120px;">Created</th>
                            <th style="width:280px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    @if (Model == null || !Model.Any())
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted p-4">No needs found.</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var n in Model)
                        {
                            <tr>
                                <td class="text-muted">#@n.Id</td>
                                <td>
                                    <div style="font-weight:900;">@n.Title</div>
                                    @if (!string.IsNullOrWhiteSpace(n.ShortSummary))
                                    {
                                        <div class="text-muted small">@n.ShortSummary</div>
                                    }
                                </td>
                                <td class="text-muted">@n.Category</td>
                                <td class="text-muted">@n.Location</td>
                                <td>@n.GoalAmount.ToString("C")</td>
                                <td class="text-muted">@n.AmountRaised.ToString("C")</td>
                                <td>
                                    @if (n.IsPublished)
                                    {
                                        <span class="badge bg-success">Yes</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">No</span>
                                    }
                                </td>
                                <td class="text-muted small">@n.CreatedAt.ToLocalTime().ToString("g")</td>

                                <td>
                                  <div class="d-flex gap-2 flex-wrap justify-content-end">

                                    <a class="kg-btn kg-btn-ghost"
                                       asp-controller="Needs" asp-action="Details"
                                       asp-route-id="@n.Id"
                                       asp-route-key="@key">
                                      View
                                    </a>

                                    @if (!n.IsPublished)
                                    {
                                      <form asp-controller="Admin" asp-action="ApproveNeed" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="key" value="@key" />
                                        <input type="hidden" name="id" value="@n.Id" />
                                        <button type="submit" class="kg-btn" style="background:#16a34a;border-color:#16a34a;color:#fff;">
                                          Approve
                                        </button>
                                      </form>

                                      <form asp-controller="Admin" asp-action="RejectNeed" method="post" class="d-flex gap-2">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="key" value="@key" />
                                        <input type="hidden" name="id" value="@n.Id" />
                                        <input type="text" name="reason"
                                               class="form-control form-control-sm"
                                               placeholder="Reason (required)"
                                               style="max-width:180px;"
                                               required />
                                        <button type="submit" class="kg-btn" style="background:#dc2626;border-color:#dc2626;color:#fff;">
                                          Reject
                                        </button>
                                      </form>
                                    }
                                    else
                                    {
                                      <span class="badge bg-success align-self-center">Published</span>
                                    }

                                  </div>
                                </td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-3">
            <a class="kg-btn kg-btn-ghost"
               asp-controller="Admin" asp-action="Index"
               asp-route-key="@key">Back to Admin</a>
        </div>
    </div>
</div>